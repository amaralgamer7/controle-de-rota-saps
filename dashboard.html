<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container mt-4">
    <h2 class="mb-4">Dashboard de Consumo</h2>

    <div class="row mb-5">
      <div class="col-md-6">
        <h5>Consumo por Veículo</h5>
        <canvas id="graficoVeiculos"></canvas>
      </div>
      <div class="col-md-6">
        <h5>Consumo por Motorista</h5>
        <canvas id="graficoMotoristas"></canvas>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <h4>Consumo Médio Total: <span id="consumo-medio" class="badge bg-primary"></span></h4>
      </div>
    </div>
  </div>

  <div class="text-center mt-4">
    <a href="sistema-rotas.html" class="btn btn-primary">Voltar ao Menu Principal</a>
  </div>

  <script>
    async function carregarDados() {
      const resposta = await fetch("http://localhost:3000/abastecimentos");
      const abastecimentos = await resposta.json();

      let consumoTotal = 0;
      let litrosTotal = 0;

      const porVeiculo = {};
      const porMotorista = {};

      abastecimentos.forEach(a => {
        if (!a.veiculo || !a.motorista) return;

        const placa = a.veiculo.placa;
        const motorista = a.motorista.nome;
        const consumo = a.km / a.litros;

        // Consumo total
        litrosTotal += a.litros;
        consumoTotal += a.km;

        // Veículos
        if (!porVeiculo[placa]) porVeiculo[placa] = [];
        porVeiculo[placa].push(consumo);

        // Motoristas
        if (!porMotorista[motorista]) porMotorista[motorista] = [];
        porMotorista[motorista].push(consumo);
      });

      const consumoMedio = (consumoTotal / litrosTotal).toFixed(2);
      document.getElementById("consumo-medio").textContent = consumoMedio + " km/l";

      gerarGrafico("graficoVeiculos", porVeiculo);
      gerarGrafico("graficoMotoristas", porMotorista);
    }

    function gerarGrafico(id, dados) {
      const ctx = document.getElementById(id).getContext("2d");
      const labels = Object.keys(dados);
      const valores = labels.map(l => {
        const total = dados[l].reduce((s, v) => s + v, 0);
        return (total / dados[l].length).toFixed(2);
      });

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Consumo Médio (km/l)",
            data: valores,
            backgroundColor: "rgba(54, 162, 235, 0.6)"
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    carregarDados();
  </script>
</body>
</html>
